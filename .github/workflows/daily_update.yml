name: Daily Quiz Update

on:
  schedule:
    # Runs at 9:00 AM Melbourne time (22:00 UTC previous day)
    - cron: '0 22 * * *'
  workflow_dispatch: # Allows manual trigger

# --- FIX 1: GIVE PERMISSION TO SAVE CSV ---
permissions:
  contents: write

jobs:
  daily-refresh:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      # --- FIX 2: SMART INSTALLER (Fixes the 'httr' error) ---
      - name: Install Dependencies
        uses: r-lib/actions/setup-r-dependencies@v2
        with:
          cache: true
          packages: |
            any::httr
            any::jsonlite
            any::dplyr
            any::readr
            any::stringr
            any::tidygeocoder
            any::rsconnect
            any::shiny
            any::leaflet
            any::shinyWidgets
            any::geosphere
            any::shinyjs
            any::bslib

      - name: Generate New Matches
        env:
          FLICKR_API_KEY: ${{ secrets.FLICKR_API_KEY }}
        run: Rscript builder.R

      - name: Commit New Data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add matches.csv
          git commit -m "Daily data refresh [skip ci]" || echo "No changes to commit"
          git push origin main

      # --- FIX 3: CLEAN DEPLOY (Only uploads necessary files) ---
      - name: Deploy to ShinyApps
        env:
          RSCONNECT_USER: ${{ secrets.RSCONNECT_USER }}
          RSCONNECT_TOKEN: ${{ secrets.RSCONNECT_TOKEN }}
          RSCONNECT_SECRET: ${{ secrets.RSCONNECT_SECRET }}
        run: |
          Rscript -e "library(rsconnect); setAccountInfo(name='${RSCONNECT_USER}', token='${RSCONNECT_TOKEN}', secret='${RSCONNECT_SECRET}'); deployApp(appName='football-timeguesser', appFiles=c('app.R', 'matches.csv'), forceUpdate=TRUE)"
