name: Daily Quiz Update

on:
  schedule:
    # Runs at 9:00 AM Melbourne time (22:00 UTC previous day)
    - cron: '0 22 * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  daily-refresh:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # --- THE FIX: MANUAL SYSTEM INSTALL ---
      # This explicitly installs the missing tools found in your error log.
      # libcurl4-openssl-dev -> Fixes "Configuration failed because libcurl was not found"
      # libssl-dev -> Fixes common security/crypto errors
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y libcurl4-openssl-dev libssl-dev libxml2-dev

      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true

      - name: Install R Packages
        run: |
          # Install packages (Binaries will now work because system tools are present)
          install.packages(c(
            "httr", "jsonlite", "dplyr", "readr", "stringr", "tidygeocoder", 
            "rsconnect", "shiny", "leaflet", "shinyWidgets", "geosphere", 
            "shinyjs", "bslib"
          ))
        shell: Rscript {0}

      - name: Generate New Matches
        env:
          FLICKR_API_KEY: ${{ secrets.FLICKR_API_KEY }}
        run: Rscript builder.R

      - name: Commit New Data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add matches.csv
          git commit -m "Daily data refresh" || echo "No changes to commit"
          git push origin main

      - name: Deploy to ShinyApps
        env:
          RSCONNECT_USER: ${{ secrets.RSCONNECT_USER }}
          RSCONNECT_TOKEN: ${{ secrets.RSCONNECT_TOKEN }}
          RSCONNECT_SECRET: ${{ secrets.RSCONNECT_SECRET }}
        run: |
          # appFiles ensures we only upload the necessary files, preventing errors
          Rscript -e "library(rsconnect); setAccountInfo(name='${RSCONNECT_USER}', token='${RSCONNECT_TOKEN}', secret='${RSCONNECT_SECRET}'); deployApp(appName='football-timeguesser', appFiles=c('app.R', 'matches.csv'), forceUpdate=TRUE)"
