name: Daily Quiz Update
on:
  schedule:
    # Runs at 22:00 UTC (09:00 Melbourne time)
    - cron: '0 22 * * *'
  workflow_dispatch:
permissions:
  contents: write
jobs:
  daily-refresh:
    runs-on: ubuntu-latest
    steps:
      # ------------------------------
      # 1. Checkout Repository
      # ------------------------------
      - name: Checkout Code
        uses: actions/checkout@v4
      # ------------------------------
      # 2. System Dependencies (CRITICAL)
      # ------------------------------
      - name: Install System Dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            libcurl4-openssl-dev \
            libssl-dev \
            libxml2-dev \
            pkg-config
      # ------------------------------
      # 3. Set up R
      # ------------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: 'release'
          use-public-rspm: true
      # ------------------------------
      # 4. Install R Packages
      # ------------------------------
      - name: Install R Packages
        shell: Rscript {0}
        run: |
          options(repos = c(CRAN = "https://cloud.r-project.org"))
          install.packages(c(
            "httr",
            "jsonlite",
            "dplyr",
            "readr",
            "stringr",
            "tidygeocoder",
            "rsconnect",
            "shiny",
            "leaflet",
            "shinyWidgets",
            "geosphere",
            "shinyjs",
            "bslib"
          ))
      # ------------------------------
      # 5. Build Daily Match Data
      # ------------------------------
      - name: Generate New Matches
        env:
          FLICKR_API_KEY: ${{ secrets.FLICKR_API_KEY }}
        run: Rscript builder.R
      # ------------------------------
      # 6. Commit Generated Data
      # ------------------------------
      - name: Commit New Data
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add matches.csv install.R
          git diff-index --quiet HEAD || git commit -m "Daily data refresh"
          git pull origin main --rebase || true
          git push origin main
      # ------------------------------
      # 7. Create Dependency File
      # ------------------------------
      - name: Write Dependencies
        run: |
          cat > install.R << 'EOF'
          install.packages(c(
            "shiny",
            "leaflet",
            "dplyr",
            "readr",
            "shinyWidgets",
            "geosphere",
            "shinyjs",
            "bslib"
          ))
          EOF
      # ------------------------------
      # 8. Deploy to ShinyApps.io
      # ------------------------------
      - name: Deploy to ShinyApps
        env:
          RSCONNECT_USER: ${{ secrets.RSCONNECT_USER }}
          RSCONNECT_TOKEN: ${{ secrets.RSCONNECT_TOKEN }}
          RSCONNECT_SECRET: ${{ secrets.RSCONNECT_SECRET }}
        run: |
          Rscript -e "
            library(rsconnect)
            setAccountInfo(
              name   = Sys.getenv('RSCONNECT_USER'),
              token  = Sys.getenv('RSCONNECT_TOKEN'),
              secret = Sys.getenv('RSCONNECT_SECRET')
            )
            deployApp(
              appName   = 'football-timeguesser',
              appFiles  = c('app.R', 'matches.csv', 'install.R'),
              forceUpdate = TRUE,
              launch.browser = FALSE,
              lint = FALSE
            )
          "
